{% extends "game/base.html" %} 
{% block title %}{{ game.name }} -  ♦︎ ♣︎ ♥︎ ♠︎{% endblock %}
{% block content %}

<h2>{{ game.name }}</h2>
<p>
  {{ game.get_game_type_display }} - {{ game.get_betting_type_display }}<br>
  Buy-in: {{ game.buy_in }} - Blinds: {{ game.small_blind }}/{{ game.big_blind }}<br>
  Blind Timer: {{ game.blind_timer }} minutes{% if game.blind_timer == 0 %} (No increase){% endif %}
</p>

<p>Status: <span id="game-status">{{ game.status }}</span></p>

<!-- Display a list of player on this table -->
<h3>Players (<span id="player-count">{{ players.count }}</span>/{{ game.max_players }})</h3>
<ul id="players-list">
  {% for player in players %}
    <li data-position="{{ player.position }}">
      {{ player.user.username }} (Position: {{ player.position }})
    </li>
  {% endfor %}
</ul>

<!-- Join Table Button (Initially shown) -->
<button id="join-button" onclick="sendJoin()" 
    {% if is_player or players|length >= game.max_players %}style="display:none;"{% endif %}>
    Join Table
</button>

<!-- Leave Table Button (Initially hidden if not a player) -->
<button id="leave-button" onclick="sendLeave()" 
    {% if not is_player %}style="display:none;"{% endif %}>
    Leave Table
</button>
<hr>



  <p>Dealer: <span id="dealer">
    {% for player in players %}
      {% if player.position == game.dealer_position %}
        {{ player.user.username }}
      {% endif %}
    {% endfor %}
  </span></p>


  <!-- Display the current player's turn -->
  Player's turn : <span id="current-turn">
    {% for player in players %}
      {% if player.position == game.current_turn %}
        {{ player.user.username }}
      {% endif %}
    {% endfor %}
  </span>




<!-- Player Actions -->
<div id="action-buttons-container" style="display: block;">
    <h3>Action:</h3>
    <button id="check-button" onclick="sendAction('check')" class="action-button" disabled>Check</button>
    <button id="fold-button" onclick="sendAction('fold')" class="action-button" disabled>Fold</button>
</div>



<h3>Messages:</h3>
<ul id="action-messages"></ul>





<script>

  let gameId = "{{ game.id }}";  // Get the game ID
  let username = "{{ request.user.username }}";  // Get the current user's name
  let reconnectInterval = 3000;  // 3 seconds before trying to reconnect
  let currentTurnUsername = "{{ current_turn_username }}";  // Get initial turn username
  //let socket = null;
  

  function sendAction(action) {
    // Ensure WebSocket is open before sending data
    if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ action: action, player: username }));
        console.log(`🟢 Sent action: ${action} by ${username}`);
    } else {
        console.warn("WebSocket is not open. Cannot send action.");
    }
  }



  function updatePlayerList(players) {
        const playerList = document.getElementById("players-list");
        const playerCount = document.getElementById("player-count");

        // Clear current list
        playerList.innerHTML = "";

        // Update player count
        playerCount.innerText = players.length;

        // Add updated players
        players.forEach(player => {
            const li = document.createElement("li");
            li.setAttribute("data-position", player.position);
            li.textContent = `${player.username} (Position: ${player.position})`;
            playerList.appendChild(li);
        });
    }







  function connectWebSocket() {

    socket = new WebSocket(`ws://${window.location.host}/ws/game/${gameId}/`);

    socket.onopen = function () {
      console.log("WebSocket Connected");
      document.getElementById("action-messages").innerHTML = "";
    };


    socket.onmessage = function (event) {
      const ed = JSON.parse(event.data);
      
      // Debugging: Log received data
      console.log("🔵 WebSocket Message Received:", ed);

      if (ed.data) {

        if (ed.data.game_status !== undefined) {
          document.getElementById("game-status").innerText = ed.data.game_status;
        }


        if (ed.data.dealer_position !== undefined) {
          document.getElementById("dealer").innerText = 
          ed.data.players.find(p => p.position === ed.data.dealer_position)?.username || "Unknown";
        }


        if (ed.data.current_turn !== undefined) {
          document.getElementById("current-turn").innerText =
            ed.data.players.find(p => p.position === ed.data.current_turn)?.username || "Unknown";
        }


        if (ed.data.players) {
          updatePlayerList(ed.data.players);

          const isPlayer = ed.data.players.some(player => player.username === username);
          const playerCount = ed.data.players.length;
          const maxPlayers = parseInt("{{ game.max_players }}");

          const joinButton = document.getElementById("join-button");
          const leaveButton = document.getElementById("leave-button");

          // Handle Join Button Visibility
          if (joinButton) {
              joinButton.style.display = isPlayer || playerCount >= maxPlayers ? "none" : "block";
          }

          // Handle Leave Button Visibility
          if (leaveButton) {
              leaveButton.style.display = isPlayer ? "block" : "none";
          }
        }

        if (ed.data.current_username || ed.data.current_username === "") {
          let actionButtons = document.querySelectorAll(".action-button");
          actionButtons.forEach(button => {
              if (typeof username !== "" && username === ed.data.current_username && ed.data.game_status === "active") {
                  button.disabled = false;  // Enable for current turn user
              } else {
                  button.disabled = true;   // Disable for others
              }
          });
        }


      }
      
    
      // Handle action messages
      if (ed.messages) {
          
          let messagesList = document.getElementById("action-messages");
          messagesList.innerHTML = ""; 

          // Ensure the `ul` element exists before modifying
          if (!messagesList) {
              console.error("❌ Error: 'action-messages' element not found!");
              return;
          }
          ed.messages.forEach(msg => {
              let li = document.createElement("li");
              li.innerText = msg;
              // messagesList.appendChild(li);
              messagesList.insertBefore(li, messagesList.firstChild);
          });
      }

    };


    socket.onclose = function (event) {
      console.warn("WebSocket Disconnected. Reconnecting in 3 seconds...");
      setTimeout(connectWebSocket, reconnectInterval);  // Auto-reconnect
    };

    socket.onerror = function (error) { 
      socket.close();  // Force reconnect on error
    };

  }

  
  window.onload = function() {
    // Ensure buttons are enabled correctly on page load
    const actionButtons = document.querySelectorAll(".action-button");
    if (currentTurnUsername === username) {
        actionButtons.forEach(button => button.disabled = false);
    } else {
        actionButtons.forEach(button => button.disabled = true);
    }
  };



  function sendJoin() {
    socket.send(JSON.stringify({ action: "join", player: username }));
  }

  function sendLeave() {
    socket.send(JSON.stringify({ action: "leave", player: username }));
  }

  // Initial WebSocket Connection
  connectWebSocket();

</script>

{% endblock %}